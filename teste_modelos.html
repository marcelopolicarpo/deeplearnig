<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reconhecimento de Caracteres Manuscritos</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ícones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .card {
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border: none;
            border-radius: 15px;
        }
        #video, #photo {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #result {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .info-box {
            background-color: #e9f5ff;
            border-left: 5px solid #007bff;
            padding: 15px;
            border-radius: 8px;
        }
    </style>

    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
</head>
<body class="d-flex align-items-center py-4">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-md-8 col-lg-6">
                <div class="card p-4 p-md-5">
                    <h2 class="text-center mb-4 text-primary">
                        <i class="bi bi-camera-fill me-2"></i>
                        Reconhecimento de Caracteres Manuscritos
                    </h2>

                    <!-- Seletor de Modelo -->
                    <div class="mb-4">
                        <label for="modelSelect" class="form-label fw-bold">Escolha o modelo:</label>
                        <select id="modelSelect" class="form-select form-select-lg">
                            <option value="vf">Apenas V ou F</option>
                            <option value="combined">Dígitos 1-5 e Letras A-E</option>
                        </select>
                    </div>

                    <!-- Informações do modelo -->
                    <div class="info-box mb-4" id="modelInfo">
                        <strong>Modelo selecionado:</strong> Apenas V ou F<br>
                        Escreva uma letra maiúscula <strong>V</strong> ou <strong>F</strong> grande e centralizada.
                    </div>

                    <!-- Vídeo da câmera -->
                    <div class="text-center mb-4 position-relative">
                        <video id="video" class="img-fluid" autoplay playsinline style="max-height: 400px;"></video>
                        <div class="position-absolute top-50 start-50 translate-middle text-white bg-dark bg-opacity-50 px-3 py-1 rounded" 
                             id="cameraStatus">Inicializando câmera...</div>
                    </div>

                    <!-- Botão de captura -->
                    <div class="d-grid mb-4">
                        <button id="captureButton" class="btn btn-primary btn-lg" disabled>
                            <i class="bi bi-camera me-2"></i> Tirar Foto e Reconhecer
                        </button>
                    </div>

                    <!-- Foto capturada -->
                    <div class="text-center mb-4" id="photoContainer" style="display: none;">
                        <h5>Foto Capturada:</h5>
                        <img id="photo" class="img-fluid" alt="Foto capturada" style="max-height: 300px;">
                    </div>

                    <!-- Resultado -->
                    <div class="text-center" id="result">
                        <p class="text-muted">Selecione o modelo e tire uma foto para começar.</p>
                    </div>
                </div>

                <div class="text-center mt-4 text-muted small">
                    <i class="bi bi-info-circle"></i>
                    Dica: Fundo claro, caractere escuro, grande e centralizado.
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas oculto -->
    <canvas id="canvas" style="display: none;"></canvas>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const photo = document.getElementById('photo');
        const photoContainer = document.getElementById('photoContainer');
        const captureButton = document.getElementById('captureButton');
        const resultDiv = document.getElementById('result');
        const modelSelect = document.getElementById('modelSelect');
        const modelInfo = document.getElementById('modelInfo');
        const cameraStatus = document.getElementById('cameraStatus');

        let model = null;
        let currentModelName = 'vf';

        const classes = {
            vf: ['F', 'V'],
            combined: ['1', '2', '3', '4', '5', 'A', 'B', 'C', 'D', 'E']
        };

        const modelConfigs = {
            vf: {
                path: './model_vf_js/model.json',
                info: 'Escreva uma letra maiúscula <strong>V</strong> ou <strong>F</strong> grande e centralizada.'
            },
            combined: {
                path: './model_combined_js/model.json',
                info: 'Escreva um <strong>dígito de 1 a 5</strong> ou uma letra maiúscula <strong>A, B, C, D ou E</strong> grande e centralizada.'
            }
        };

        // Atualiza info ao mudar modelo
        modelSelect.addEventListener('change', () => {
            currentModelName = modelSelect.value;
            const selectedText = modelSelect.options[modelSelect.selectedIndex].text;
            modelInfo.innerHTML = `<strong>Modelo selecionado:</strong> ${selectedText}<br>${modelConfigs[currentModelName].info}`;
            resultDiv.innerHTML = '<p class="text-muted">Carregando novo modelo...</p>';
            photoContainer.style.display = 'none';
            loadModel();
        });

        // Carregar modelo
        async function loadModel() {
            captureButton.disabled = true;
            resultDiv.innerHTML = '<p class="text-info"><i class="bi bi-hourglass-split"></i> Carregando modelo...</p>';
            try {
                model = await tf.loadLayersModel(modelConfigs[currentModelName].path);
                resultDiv.innerHTML = '<p class="text-success"><i class="bi bi-check-circle"></i> Modelo carregado! Pronto para usar.</p>';
                captureButton.disabled = false;
            } catch (err) {
                console.error('Erro:', err);
                resultDiv.innerHTML = '<p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Erro ao carregar o modelo. Verifique as pastas.</p>';
            }
        }

        // Iniciar câmera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    cameraStatus.style.display = 'none';
                };
            } catch (err) {
                cameraStatus.textContent = 'Erro na câmera';
                cameraStatus.classList.add('bg-danger');
                resultDiv.innerHTML = `<p class="text-danger">Erro na câmera: ${err.message}</p>`;
            }
        }

        // Pré-processamento (EMNIST: fundo claro → inverte)
        async function preprocessImage(canvas) {
            const imageTensor = tf.browser.fromPixels(canvas);
            const resized = tf.image.resizeBilinear(imageTensor, [28, 28]);
            const grayscale = resized.mean(2);
            const normalized = grayscale.div(255);
            const inverted = tf.sub(1, normalized);
            const input = inverted.expandDims(0).expandDims(-1);
            return input;
        }

        // Captura e predição
        captureButton.addEventListener('click', async () => {
            if (!model) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            photo.src = canvas.toDataURL('image/jpeg');
            photoContainer.style.display = 'block';

            resultDiv.innerHTML = '<p class="text-info"><i class="bi bi-hourglass-split"></i> Processando...</p>';

            const inputTensor = await preprocessImage(canvas);
            const prediction = model.predict(inputTensor);
            const predictedIdx = prediction.argMax(-1).dataSync()[0];
            const confidence = (prediction.max().dataSync()[0] * 100).toFixed(1);

            const predictedChar = classes[currentModelName][predictedIdx];

            resultDiv.innerHTML = `
                <div class="alert alert-success p-4">
                    <h3><i class="bi bi-trophy"></i> Resultado:</h3>
                    <h1 class="display-1 text-primary">${predictedChar}</h1>
                    <p class="lead">Confiança: <strong>${confidence}%</strong></p>
                </div>
            `;

            inputTensor.dispose();
            prediction.dispose();
        });

        // Inicialização
        window.addEventListener('load', () => {
            startCamera();
            loadModel();
        });
    </script>
</body>
</html>